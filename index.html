<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sēņotājs — Web pilots (PWA)</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Sēņotājs" />
  <meta name="theme-color" content="#8b5cf6"/>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    html, body { height: 100%; margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    header { padding: .75rem 1rem; display: flex; gap: .5rem; align-items: center; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: #fff; z-index: 1000; }
    header h1 { font-size: 1.1rem; margin: 0; font-weight: 700; }
    header .spacer { flex: 1; }
    button, .btn { appearance: none; border: 1px solid #d1d5db; background: #fff; padding: .5rem .75rem; border-radius: .75rem; font-weight: 600; }
    button.primary { background: #8b5cf6; border-color: #7c3aed; color: #fff; }
    button:disabled { opacity: .5; }
    #map { height: 100%; width: 100%; }
    .floating { position: absolute; right: .75rem; bottom: .75rem; display: grid; gap: .5rem; }
    .card { background: rgba(255,255,255,.96); backdrop-filter: saturate(1.2) blur(6px); border: 1px solid #e5e7eb; border-radius: 1rem; padding: .75rem; box-shadow: 0 10px 20px rgba(0,0,0,.06); }
    .sheet { position: fixed; left: 0; right: 0; bottom: 0; background: #fff; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -10px 30px rgba(0,0,0,.2); padding: 1rem; max-height: 80vh; overflow: auto; }
    .row { display: grid; gap: .5rem; margin-bottom: .75rem; }
    label { font-size: .85rem; color: #374151; }
    input[type="text"], textarea, select { width: 100%; padding: .6rem .7rem; border-radius: .6rem; border: 1px solid #d1d5db; }
    .thumb { width: 100%; max-height: 200px; object-fit: cover; border-radius: .5rem; border: 1px solid #e5e7eb; }
    .badge { display: inline-block; font-size: .75rem; padding: .25rem .5rem; border-radius: 999px; border: 1px solid #e5e7eb; background:#f9fafb }
    footer { padding: .5rem; text-align: center; font-size: .8rem; color: #6b7280; border-top: 1px solid #e5e7eb; }
    .warn { color:#b45309; }
    .ok { color:#065f46; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>Sēņotājs (web pilots)</h1>
    <span class="badge" id="count">0 punkti</span>
    <div class="spacer"></div>
    <button id="btn-locate">Mana vieta</button>
    <button id="btn-add" class="primary">+ Pievienot</button>
  </header>
  <div id="map"></div>
  <footer>
    Foto ar GPS ir <b>obligāts</b>. Ja foto nav GPS, punkts netiks saglabāts. Dati glabājas šajā ierīcē. <span id="pwa-status"></span>
  </footer>
</div>

<!-- Sheet for adding a spot -->
<div id="sheet" class="sheet" style="display:none">
  <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem">
    <strong>Jauns punkts</strong>
    <div class="spacer"></div>
    <button id="btn-close">Aizvērt</button>
  </div>
  <div class="row">
    <label>Foto (obligāts ar GPS)</label>
    <input type="file" accept="image/*" id="photo" capture="environment" />
    <img id="preview" class="thumb" style="display:none" />
    <div id="gps-indicator" class="badge">GPS nav nolasīts</div>
    <div id="age-indicator" class="badge">Foto vecums: —</div>
  </div>
  <div class="row"><label>Nosaukums</label><input type="text" id="title" placeholder="Kāda sēne / vieta" /></div>
  <div class="row"><label>Suga</label><input type="text" id="species" placeholder="Piem., baravika" /></div>
  <div class="row"><label>Sezona</label>
    <select id="season">
      <option value="">—</option>
      <option>Vasara</option>
      <option>Rudens</option>
      <option>Pavasaris</option>
    </select>
  </div>
  <div class="row"><label>Apraksts</label><textarea id="desc" rows="3" placeholder="Piem., pie bērziem, labā malciņa"></textarea></div>
  <div class="row">
    <label><input type="checkbox" id="allow-outside-lv"> Atļaut punktus ārpus Latvijas robežām</label>
  </div>
  <div class="row" style="display:flex; gap:.5rem">
    <button id="btn-save" class="primary" disabled>Saglabāt</button>
    <button id="btn-reset">Notīrīt</button>
  </div>
</div>

<!-- Floating actions -->
<div class="floating">
  <div class="card" style="display:grid; gap:.5rem;">
    <button id="btn-export">Eksportēt (.json)</button>
    <input type="file" id="import" accept="application/json" style="display:none" />
    <button id="btn-import">Importēt</button>
    <button id="btn-clear" style="color:#b91c1c; border-color:#fecaca;">Dzēst visu</button>
  </div>
</div>

<!-- Dependencies -->
<script src="https://unpkg.com/exifr@7.1.3/dist/full.umd.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// --- State ---
const state = {
  map: null,
  cluster: null,
  data: [], // {id,title,species,season,desc,lat,lng,photoDataURL,createdAt}
};

const $ = sel => document.querySelector(sel);

// --- Local Storage ---
const KEY = 'mushroommap.spots.v2';
function load() {
  try { state.data = JSON.parse(localStorage.getItem(KEY) || '[]'); }
  catch { state.data = []; }
  $('#count').textContent = `${state.data.length} punkti`;
}
function save() {
  localStorage.setItem(KEY, JSON.stringify(state.data));
  $('#count').textContent = `${state.data.length} punkti`;
}

// --- Map init ---
function initMap() {
  state.map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(state.map);
  state.cluster = L.markerClusterGroup();
  state.map.addLayer(state.cluster);
  state.map.setView([56.9496, 24.1052], 12); // Rīga kā noklusējums
  renderMarkers();
}

function popupHtml(s) {
  return `
    <div style="min-width:180px">
      <strong>${escapeHtml(s.title || 'Sēņu vieta')}</strong><br/>
      <small>${fmt(s.species)} ${fmt(s.season)}</small><br/>
      ${s.photoDataURL ? `<img src="${s.photoDataURL}" style="width:100%;max-height:140px;object-fit:cover;margin-top:.25rem;border-radius:.35rem;border:1px solid #eee"/>` : ''}
      ${s.desc ? `<div style='margin-top:.25rem'>${escapeHtml(s.desc)}</div>` : ''}
      <div style="margin-top:.25rem;color:#6b7280;font-size:.8rem">${s.lat.toFixed(5)}, ${s.lng.toFixed(5)}</div>
    </div>`;
}

function renderMarkers() {
  state.cluster.clearLayers();
  state.data.forEach(s => {
    const m = L.marker([s.lat, s.lng]);
    m.bindPopup(popupHtml(s));
    state.cluster.addLayer(m);
  });
}

function escapeHtml(str){ return (str||'').replace(/[&<>"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;"}[s])); }
function fmt(x){ return x ? `<span class='badge'>${escapeHtml(x)}</span>` : ''; }

// --- UI controls ---
$('#btn-locate').addEventListener('click', ()=>{
  if (!navigator.geolocation) return alert('Šajā ierīcē nav pieejams GPS.');
  navigator.geolocation.getCurrentPosition(pos=>{
    state.map.setView([pos.coords.latitude, pos.coords.longitude], 14);
  }, ()=> alert('Neizdevās iegūt atrašanās vietu.')); 
});

const sheet = $('#sheet');
$('#btn-add').onclick = ()=> { sheet.style.display = 'block'; };
$('#btn-close').onclick = ()=> { resetForm(); sheet.style.display = 'none'; };
$('#btn-reset').onclick = ()=> resetForm();

const photoInput = $('#photo');
const preview = $('#preview');
const gpsBadge = $('#gps-indicator');
const ageBadge = $('#age-indicator');
let currentGPS = null;
let currentPhotoDataURL = null;
let currentPhotoAgeDays = null;

function withinLatvia(coord) {
  // Rough bbox for LV
  const latOK = coord.lat >= 55.67 && coord.lat <= 58.10;
  const lngOK = coord.lng >= 20.97 && coord.lng <= 28.25;
  return latOK && lngOK;
}

async function resizeImage(file, maxWidth=1280) {
  // returns dataURL resized (to reduce storage)
  const img = new Image();
  const blobURL = URL.createObjectURL(file);
  await new Promise(res=>{ img.onload = res; img.src = blobURL; });
  const scale = Math.min(1, maxWidth / img.width);
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  const dataURL = canvas.toDataURL('image/jpeg', 0.85);
  URL.revokeObjectURL(blobURL);
  return dataURL;
}

photoInput.addEventListener('change', async (e)=>{
  currentGPS = null; currentPhotoDataURL = null; currentPhotoAgeDays = null;
  gpsBadge.textContent = 'GPS tiek nolasīts…'; ageBadge.textContent = 'Foto vecums: —';
  const file = e.target.files?.[0];
  if (!file) { gpsBadge.textContent = 'GPS nav nolasīts'; return; }

  try {
    const exif = await exifr.parse(file, { gps: true });
    if (exif && exif.latitude && exif.longitude) {
      currentGPS = { lat: exif.latitude, lng: exif.longitude };
      gpsBadge.textContent = `GPS: ${exif.latitude.toFixed(5)}, ${exif.longitude.toFixed(5)}`;
      if (!withinLatvia(currentGPS) && !$('#allow-outside-lv').checked) {
        gpsBadge.textContent += '  (ārpus LV – atzīmē atļauju, ja apzināti)';
      }
    } else {
      gpsBadge.textContent = 'GPS nav atrasts – pārbaudi kameras iestatījumus';
    }

    // age check
    const ts = exif.DateTimeOriginal || exif.CreateDate || exif.ModifyDate;
    if (ts) {
      const d = new Date(ts);
      if (!isNaN(d)) {
        const days = Math.round((Date.now() - d.getTime())/86400000);
        currentPhotoAgeDays = days;
        ageBadge.textContent = `Foto vecums: ${days} d.`;
        if (days > 30) ageBadge.classList.add('warn'); else ageBadge.classList.remove('warn');
      }
    }
  } catch(err){
    console.error(err);
    gpsBadge.textContent = 'Kļūda lasot EXIF';
  }

  // Preview (resized)
  try {
    currentPhotoDataURL = await resizeImage(file);
    preview.src = currentPhotoDataURL; 
    preview.style.display = 'block';
  } catch(e) {
    // fallback
    const reader = new FileReader();
    reader.onload = ev => { preview.src = ev.target.result; preview.style.display = 'block'; currentPhotoDataURL = ev.target.result; };
    reader.readAsDataURL(file);
  }

  validateForm();
});

function validateForm(){
  let ok = !!($('#title').value.trim()) && !!currentGPS && !!currentPhotoDataURL;
  if (currentGPS && !withinLatvia(currentGPS) && !$('#allow-outside-lv').checked) ok = false;
  $('#btn-save').disabled = !ok;
}
['title','species','season','desc','allow-outside-lv'].forEach(id => { document.getElementById(id)?.addEventListener('input', validateForm); });

function isDuplicate(coord) {
  // consider dup if within ~15 meters (approx 0.00015 deg)
  const eps = 0.00015;
  return state.data.some(s => Math.abs(s.lat - coord.lat) < eps && Math.abs(s.lng - coord.lng) < eps);
}

$('#btn-save').addEventListener('click', ()=>{
  if (!currentGPS) { alert('Nepieciešamas GPS koordinātes foto metadatos.'); return; }
  if (!withinLatvia(currentGPS) && !$('#allow-outside-lv').checked) { 
    alert('Punkts ārpus Latvijas. Atzīmē atļauju, ja tas ir apzināti.');
    return;
  }
  if (isDuplicate(currentGPS)) {
    if (!confirm('Šajā vietā jau ir punkts (≈15 m). Turpināt?')) return;
  }
  const item = {
    id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
    title: $('#title').value.trim(),
    species: $('#species').value.trim(),
    season: $('#season').value,
    desc: $('#desc').value.trim(),
    lat: currentGPS.lat,
    lng: currentGPS.lng,
    photoDataURL: currentPhotoDataURL,
    createdAt: Date.now()
  };
  state.data.push(item);
  save();
  renderMarkers();
  resetForm();
  sheet.style.display = 'none';
  state.map.setView([item.lat, item.lng], 15);
});

function resetForm(){
  $('#title').value=''; $('#species').value=''; $('#season').value=''; $('#desc').value='';
  $('#photo').value=''; $('#preview').src=''; $('#preview').style.display='none';
  currentGPS=null; currentPhotoDataURL=null; $('#gps-indicator').textContent='GPS nav nolasīts';
  $('#age-indicator').textContent='Foto vecums: —'; document.getElementById('allow-outside-lv').checked=false;
  validateForm();
}

// Export/Import/Clear
$('#btn-export').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download='senotajs-spots.json'; a.click(); URL.revokeObjectURL(url);
};
$('#btn-import').onclick = ()=> document.getElementById('import').click();
document.getElementById('import').addEventListener('change', async e=>{
  const file = e.target.files?.[0]; if (!file) return;
  try { const text = await file.text(); const arr = JSON.parse(text); if (Array.isArray(arr)) { state.data = arr; save(); renderMarkers(); } }
  catch { alert('Neizdevās importēt.'); }
});
$('#btn-clear').onclick = ()=>{
  if (confirm('Dzēst visus punktus šajā ierīcē?')) { state.data=[]; save(); renderMarkers(); }
};

// PWA registration
(function(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js').then(()=>{
      document.getElementById('pwa-status').textContent = ' · Offline atbalsts ieslēgts';
    }).catch(()=>{});
  }
})();

// Init
load();
initMap();
</script>
</body>
</html>
